<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Jarvis Analyst</title>
    <meta name="description" content="Resultados y análisis del sistema Jarvis Analyst - Conversational Analytics, Zero Friction.">
    
    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <link rel="stylesheet" href="/static/styles.css?v=1.0">
    
    <!-- Theme detection script -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.classList.toggle('dark', theme === 'dark');
        })();
    </script>
    <style>
        .results-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg-primary, #ffffff);
            min-height: 100vh;
        }
        
        .results-header {
            margin-bottom: 2rem;
        }
        
        .results-header h1 {
            background: linear-gradient(135deg, var(--brand-blue, #1565C0) 0%, var(--brand-teal, #1DBFAC) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .result-card {
            background: var(--bg-primary, white);
            border: 1px solid var(--border-color, #E2E8F0);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px var(--shadow-color, rgba(15, 23, 42, 0.1));
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color, rgba(15, 23, 42, 0.15));
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary, #1E293B);
        }
        
        .result-timestamp {
            color: var(--text-muted, #94A3B8);
            font-size: 0.875rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .result-content {
            line-height: 1.6;
            color: var(--text-secondary, #64748B);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted, #94A3B8);
        }
        
        .error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .btn {
            background: var(--brand-blue, #1565C0);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.25rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--text-muted, #94A3B8);
        }
        
        .btn-secondary:hover {
            background: var(--text-secondary, #64748B);
        }
        
        .btn-cta {
            background: var(--cta-orange, #FF8F00);
        }
        
        .btn-cta:hover {
            background: #F57C00;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <div class="logo-icon">
                        <span>J</span>
                    </div>
                    <span class="logo-text">Jarvis Analyst</span>
                </div>
                
                <!-- Actions -->
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i data-lucide="sun" class="sun-icon"></i>
                        <i data-lucide="moon" class="moon-icon"></i>
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='/'">
                        <i data-lucide="arrow-left"></i>
                        Back to Jarvis Analyst
                    </button>
                </div>
                
                <!-- Mobile menu button -->
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i data-lucide="menu"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="results-container">
        <div class="results-header">
            <h1>Resultados del Sistema</h1>
        </div>
        
        <div class="main-buttons" style="margin-bottom: 2rem; text-align: center;">
            <button class="btn btn-primary" onclick="loadResults()">
                <i data-lucide="refresh-cw"></i>
                Actualizar Resultados
            </button>
            <button class="btn btn-primary" onclick="runTests()">
                <i data-lucide="play"></i>
                Ejecutar Pruebas
            </button>
            <button class="btn btn-primary" onclick="runEvaluations()">
                <i data-lucide="check-circle"></i>
                Ejecutar Evaluaciones
            </button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            Cargando resultados...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <!-- Interactive Menu System -->
        <div class="menu-system">
            <div class="menu-tabs">
                <button class="tab-button active" onclick="showTab('tests')">
                    <i data-lucide="check-circle"></i>
                    Tests Status
                </button>
                <button class="tab-button" onclick="showTab('evaluations')">
                    <i data-lucide="alert-circle"></i>
                    Test Failures
                </button>
                <button class="tab-button" onclick="showTab('reactions')">
                    <i data-lucide="message-circle"></i>
                    Model Reactions
                </button>
            </div>
            
            <div class="tab-content">
                <!-- Tests Status Tab -->
                <div id="tests-tab" class="tab-panel active">
                    <div class="panel-header">
                        <h3>Tests Status by System Properties</h3>
                    </div>
                    <div class="status-sections">
                        <div class="status-section passed">
                            <h4><i data-lucide="check"></i> Passed Tests</h4>
                            <div id="passed-tests-list" class="items-list">
                                <div class="loading">Loading passed tests...</div>
                            </div>
                        </div>
                        <div class="status-section failed">
                            <h4><i data-lucide="x"></i> Failed Tests</h4>
                            <div id="failed-tests-list" class="items-list">
                                <div class="loading">Loading failed tests...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Failures Tab -->
                <div id="evaluations-tab" class="tab-panel">
                    <div class="panel-header">
                        <h3>Why Tests Failed</h3>
                    </div>
                    <div id="test-failures-list" class="items-list">
                        <div class="loading">Loading test failure reasons...</div>
                    </div>
                </div>
                
                <!-- Model Reactions Tab -->
                <div id="reactions-tab" class="tab-panel">
                    <div class="panel-header">
                        <h3>Model Evaluation Reactions</h3>
                    </div>
                    <div id="model-reactions-list" class="items-list">
                        <div class="loading">Loading model reactions...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Container -->
        <div class="results-box">
            <div class="results-box-header">
                <h3><i data-lucide="file-text"></i> Resultados del Sistema</h3>
                <div class="results-count" id="results-count">0 resultados</div>
            </div>
            <div id="results-content" class="results-content-wrapper">
                <!-- Los resultados se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Función para cargar resultados
        async function loadResults() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('results-content');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            content.innerHTML = '';
            
            try {
                const response = await fetch('/api/results/list');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayResults(data);
            } catch (err) {
                console.error('Error loading results:', err);
                error.textContent = `Error al cargar resultados: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Función para mostrar resultados
        function displayResults(data) {
            const content = document.getElementById('results-content');
            const counter = document.getElementById('results-count');
            
            // Actualizar contador
            const count = data ? data.length : 0;
            counter.textContent = `${count} resultado${count !== 1 ? 's' : ''}`;
            
            // Limpiar contenido anterior
            content.innerHTML = '';
            
            if (!data || data.length === 0) {
                return; // El CSS se encarga de mostrar el mensaje "No hay resultados disponibles"
            }
            
            data.forEach(result => {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                if (result.data && result.data.modelos_evaluados) {
                    // Format evaluation results
                    card.innerHTML = formatEvaluationResult(result);
                } else if (result.data && (result.data.categories || result.data.test_details || result.data.total_tests !== undefined)) {
                    // Format test results
                    card.innerHTML = formatTestResult(result);
                } else {
                    // Default JSON format for other types
                    card.innerHTML = `
                        <div class="result-header">
                            <div class="result-title">${result.title || 'Resultado'}</div>
                            <div class="result-timestamp">${result.timestamp || ''}</div>
                        </div>
                        <div class="result-content">
                            <pre class="json-content">${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
                
                content.appendChild(card);
            });
        }
        
        function formatEvaluationResult(result) {
            const data = result.data;
            const modelData = Object.values(data.modelos_evaluados)[0]; // Get first model
            
            let categoriesHtml = '';
            if (modelData && modelData.categorias) {
                Object.entries(modelData.categorias).forEach(([category, categoryData]) => {
                    categoriesHtml += `
                        <div class="category-section">
                            <h4 class="category-title">${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value">${categoryData.puntuacion_promedio?.toFixed(1) || 'N/A'}</div>
                                    <div class="metric-label">Puntuación Promedio</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${categoryData.mejor_puntuacion || 'N/A'}</div>
                                    <div class="metric-label">Mejor Puntuación</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${categoryData.peor_puntuacion || 'N/A'}</div>
                                    <div class="metric-label">Peor Puntuación</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${categoryData.prompts?.length || 0}</div>
                                    <div class="metric-label">Total Prompts</div>
                                </div>
                            </div>
                            
                            <div class="prompts-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Prompt</th>
                                            <th>Puntuación</th>
                                            <th>Tiempo (s)</th>
                                            <th>Longitud</th>
                                            <th>Criterios</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categoryData.prompts?.map(prompt => `
                                            <tr>
                                                <td class="prompt-text">${prompt.prompt?.substring(0, 50) || 'N/A'}...</td>
                                                <td><span class="score-badge score-${getScoreClass(prompt.puntuacion)}">${prompt.puntuacion || 'N/A'}</span></td>
                                                <td>${prompt.tiempo_respuesta?.toFixed(2) || 'N/A'}</td>
                                                <td>${prompt.longitud_respuesta || 'N/A'}</td>
                                                <td class="criteria-list">
                                                    ${Object.entries(prompt.criterios || {}).map(([key, value]) => 
                                                        `<span class="criteria-item ${value ? 'passed' : 'failed'}">${key}</span>`
                                                    ).join('')}
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="5">No hay datos de prompts</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }
            
            return `
                <div class="result-header">
                    <div class="result-title">${result.title || 'Evaluación'}</div>
                    <div class="result-timestamp">${result.timestamp || ''}</div>
                </div>
                <div class="result-content">
                    <div class="evaluation-summary">
                        <div class="summary-metrics">
                            <div class="metric-card primary">
                                <div class="metric-value">${modelData?.resumen?.puntuacion_total || 'N/A'}</div>
                                <div class="metric-label">Puntuación Total</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${modelData?.resumen?.prompts_evaluados || 0}</div>
                                <div class="metric-label">Prompts Evaluados</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${modelData?.resumen?.prompts_exitosos || 0}</div>
                                <div class="metric-label">Prompts Exitosos</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${modelData?.modelo || 'N/A'}</div>
                                <div class="metric-label">Modelo</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="categories-container">
                        ${categoriesHtml}
                    </div>
                </div>
            `;
        }
        
        function formatTestResult(result) {
            const data = result.data;
            
            // Build categories HTML
            let categoriesHtml = '';
            if (data && data.categories) {
                Object.entries(data.categories).forEach(([category, categoryData]) => {
                    const categoryName = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    categoriesHtml += `
                        <div class="category-section">
                            <h4 class="category-title">${categoryName}</h4>
                            <div class="metrics-grid">
                                <div class="metric-card success">
                                    <div class="metric-value">${categoryData.passed || 0}</div>
                                    <div class="metric-label">Exitosas</div>
                                </div>
                                <div class="metric-card error">
                                    <div class="metric-value">${categoryData.failed || 0}</div>
                                    <div class="metric-label">Fallidas</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${categoryData.skipped || 0}</div>
                                    <div class="metric-label">Omitidas</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${(categoryData.passed + categoryData.failed + categoryData.skipped) || 0}</div>
                                    <div class="metric-label">Total</div>
                                </div>
                            </div>
                            
                            <div class="tests-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Prueba</th>
                                            <th>Estado</th>
                                            <th>Duración</th>
                                            <th>Mensaje</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categoryData.tests?.map(test => `
                                            <tr>
                                                <td class="test-name">${test.name || test.id || 'N/A'}</td>
                                                <td><span class="status-badge ${getTestStatusClass(test.status)}">${formatTestStatus(test.status)}</span></td>
                                                <td>${test.duration || test.time || 'N/A'}</td>
                                                <td class="test-message">${test.message || test.error || test.output || 'N/A'}</td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="4">No hay pruebas en esta categoría</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }
            
            // If no categories, show test_details if available
            if (!categoriesHtml && data && data.test_details && data.test_details.length > 0) {
                categoriesHtml = `
                    <div class="category-section">
                        <h4 class="category-title">Resultados de Pruebas</h4>
                        <div class="tests-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Prueba</th>
                                        <th>Estado</th>
                                        <th>Duración</th>
                                        <th>Mensaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.test_details.map(test => `
                                        <tr>
                                            <td class="test-name">${test.name || test.id || 'N/A'}</td>
                                            <td><span class="status-badge ${getTestStatusClass(test.status)}">${formatTestStatus(test.status)}</span></td>
                                            <td>${test.duration || test.time || 'N/A'}</td>
                                            <td class="test-message">${test.message || test.error || test.output || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="result-header">
                    <div class="result-title">${result.title || 'Pruebas'}</div>
                    <div class="result-timestamp">${result.timestamp || ''}</div>
                </div>
                <div class="result-content">
                    <div class="test-summary">
                        <div class="summary-metrics">
                            <div class="metric-card primary">
                                <div class="metric-value">${data?.total_tests || 0}</div>
                                <div class="metric-label">Total Pruebas</div>
                            </div>
                            <div class="metric-card success">
                                <div class="metric-value">${data?.passed_tests || 0}</div>
                                <div class="metric-label">Exitosas</div>
                            </div>
                            <div class="metric-card error">
                                <div class="metric-value">${data?.failed_tests || 0}</div>
                                <div class="metric-label">Fallidas</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data?.skipped_tests || 0}</div>
                                <div class="metric-label">Omitidas</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="categories-container">
                        ${categoriesHtml || '<div class="no-results">No hay datos de pruebas disponibles</div>'}
                    </div>
                </div>
            `;
        }
        
        function getTestStatusClass(status) {
            if (!status) return 'unknown';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pass') || statusLower === 'ok' || statusLower === 'success') return 'passed';
            if (statusLower.includes('fail') || statusLower === 'error' || statusLower.includes('failed')) return 'failed';
            if (statusLower.includes('skip') || statusLower === 'skipped') return 'skipped';
            return 'unknown';
        }
        
        function formatTestStatus(status) {
            if (!status) return 'Desconocido';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pass') || statusLower === 'ok' || statusLower === 'success') return 'Exitosa';
            if (statusLower.includes('fail') || statusLower === 'error' || statusLower.includes('failed')) return 'Fallida';
            if (statusLower.includes('skip') || statusLower === 'skipped') return 'Omitida';
            return status;
        }
        
        function getScoreClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'fair';
            return 'poor';
        }
        
        // Función para ejecutar pruebas
        async function runTests() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const button = event.target;
            
            // Deshabilitar botón y mostrar estado de carga
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader"></i> Ejecutando Pruebas...';
            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/results/run-tests', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Tests completed:', result);
                
                // Mostrar mensaje de éxito
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.style.cssText = 'background: #10b981; color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;';
                successMsg.innerHTML = `<i data-lucide="check-circle"></i> Pruebas ejecutadas exitosamente. Exit code: ${result.exit_code}`;
                document.querySelector('.results-container').insertBefore(successMsg, document.querySelector('.results-box'));
                
                // Remover mensaje después de 5 segundos
                setTimeout(() => successMsg.remove(), 5000);
                
                // Recargar resultados después de ejecutar pruebas
                setTimeout(loadResults, 1000);
            } catch (err) {
                console.error('Error running tests:', err);
                error.textContent = `Error al ejecutar pruebas: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                // Restaurar botón
                button.disabled = false;
                button.innerHTML = '<i data-lucide="play"></i> Ejecutar Pruebas';
                lucide.createIcons();
            }
        }
        
        // Función para ejecutar evaluaciones
        async function runEvaluations() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const button = event.target;
            
            // Deshabilitar botón y mostrar estado de carga
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader"></i> Ejecutando Evaluaciones...';
            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/results/run-evaluations', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Evaluations completed:', result);
                
                // Mostrar mensaje de éxito
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.style.cssText = 'background: #10b981; color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;';
                successMsg.innerHTML = `<i data-lucide="check-circle"></i> Evaluaciones ejecutadas exitosamente. Exit code: ${result.exit_code}`;
                document.querySelector('.results-container').insertBefore(successMsg, document.querySelector('.results-box'));
                
                // Remover mensaje después de 5 segundos
                setTimeout(() => successMsg.remove(), 5000);
                
                // Recargar resultados después de ejecutar evaluaciones
                setTimeout(loadResults, 1000);
            } catch (err) {
                console.error('Error running evaluations:', err);
                error.textContent = `Error al ejecutar evaluaciones: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                // Restaurar botón
                button.disabled = false;
                button.innerHTML = '<i data-lucide="check-circle"></i> Ejecutar Evaluaciones';
                lucide.createIcons();
            }
        }
        
        // Cargar resultados al cargar la página
        document.addEventListener('DOMContentLoaded', loadResults);
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }
        
        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                const nav = document.querySelector('.nav');
                nav.classList.toggle('mobile-open');
            });
        }
        
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab panel
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
    </script>
</body>
</html>